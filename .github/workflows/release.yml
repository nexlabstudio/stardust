name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  actions: write

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            target: darwin-x64
            arch: x64
          - os: macos-latest
            target: darwin-arm64
            arch: arm64
          - os: ubuntu-latest
            target: linux-x64
            arch: x64
          - os: ubuntu-24.04-arm
            target: linux-arm64
            arch: arm64
          - os: windows-latest
            target: windows-x64
            arch: x64

    steps:
      - uses: actions/checkout@v4

      - uses: dart-lang/setup-dart@v1
        with:
          sdk: stable
          architecture: ${{ matrix.arch }}

      - name: Install dependencies
        run: dart pub get

      - name: Run tests
        run: dart test

      - name: Extract version from tag
        id: version
        shell: bash
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Compile binary
        shell: bash
        run: |
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            dart compile exe bin/stardust.dart -o stardust.exe --define=VERSION=${{ steps.version.outputs.version }}
          else
            dart compile exe bin/stardust.dart -o stardust --define=VERSION=${{ steps.version.outputs.version }}
          fi

      - name: Package (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          chmod +x stardust
          tar -czvf stardust-${{ matrix.target }}.tar.gz stardust

      - name: Package (Windows)
        if: matrix.os == 'windows-latest'
        run: Compress-Archive -Path stardust.exe -DestinationPath stardust-${{ matrix.target }}.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: stardust-${{ matrix.target }}
          path: stardust-${{ matrix.target }}.*
          retention-days: 1

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Generate checksums
        run: |
          cd artifacts
          sha256sum stardust-* > checksums.txt
          cat checksums.txt

      - name: Extract version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Stardust ${{ steps.version.outputs.version }}
          draft: false
          prerelease: ${{ contains(github.ref, '-') }}
          generate_release_notes: true
          files: |
            artifacts/stardust-darwin-x64.tar.gz
            artifacts/stardust-darwin-arm64.tar.gz
            artifacts/stardust-linux-x64.tar.gz
            artifacts/stardust-linux-arm64.tar.gz
            artifacts/stardust-windows-x64.zip
            artifacts/checksums.txt

  update-package-manifests:
    name: Update Package Manifests
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: dev
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download checksums
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          curl -sSL "https://github.com/nexlabstudio/stardust/releases/download/v${VERSION}/checksums.txt" -o checksums.txt
          cat checksums.txt

      - name: Extract version and checksums
        id: extract
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

          # Extract checksums for each platform
          echo "darwin_x64=$(grep 'darwin-x64' checksums.txt | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "darwin_arm64=$(grep 'darwin-arm64' checksums.txt | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "linux_x64=$(grep 'linux-x64' checksums.txt | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "linux_arm64=$(grep 'linux-arm64' checksums.txt | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "windows_x64=$(grep 'windows-x64' checksums.txt | awk '{print $1}')" >> $GITHUB_OUTPUT

      - name: Update Homebrew formula
        run: |
          VERSION=${{ steps.extract.outputs.version }}

          cat > Formula/stardust.rb << 'FORMULA'
          class Stardust < Formula
            desc "Dart-native documentation generator. Beautiful docs, zero config."
            homepage "https://github.com/nexlabstudio/stardust"
            version "VERSION_PLACEHOLDER"
            license "Apache-2.0"

            on_macos do
              on_arm do
                url "https://github.com/nexlabstudio/stardust/releases/download/vVERSION_PLACEHOLDER/stardust-darwin-arm64.tar.gz"
                sha256 "DARWIN_ARM64_PLACEHOLDER"
              end
              on_intel do
                url "https://github.com/nexlabstudio/stardust/releases/download/vVERSION_PLACEHOLDER/stardust-darwin-x64.tar.gz"
                sha256 "DARWIN_X64_PLACEHOLDER"
              end
            end

            on_linux do
              on_arm do
                url "https://github.com/nexlabstudio/stardust/releases/download/vVERSION_PLACEHOLDER/stardust-linux-arm64.tar.gz"
                sha256 "LINUX_ARM64_PLACEHOLDER"
              end
              on_intel do
                url "https://github.com/nexlabstudio/stardust/releases/download/vVERSION_PLACEHOLDER/stardust-linux-x64.tar.gz"
                sha256 "LINUX_X64_PLACEHOLDER"
              end
            end

            def install
              bin.install "stardust"
            end

            test do
              assert_match "Stardust vVERSION_PLACEHOLDER", shell_output("#{bin}/stardust --version")
            end
          end
          FORMULA

          sed -i "s/VERSION_PLACEHOLDER/${VERSION}/g" Formula/stardust.rb
          sed -i "s/DARWIN_ARM64_PLACEHOLDER/${{ steps.extract.outputs.darwin_arm64 }}/g" Formula/stardust.rb
          sed -i "s/DARWIN_X64_PLACEHOLDER/${{ steps.extract.outputs.darwin_x64 }}/g" Formula/stardust.rb
          sed -i "s/LINUX_ARM64_PLACEHOLDER/${{ steps.extract.outputs.linux_arm64 }}/g" Formula/stardust.rb
          sed -i "s/LINUX_X64_PLACEHOLDER/${{ steps.extract.outputs.linux_x64 }}/g" Formula/stardust.rb

      - name: Update Scoop manifest
        run: |
          VERSION=${{ steps.extract.outputs.version }}
          HASH=${{ steps.extract.outputs.windows_x64 }}

          cat > scoop/stardust.json << EOF
          {
            "version": "${VERSION}",
            "description": "Dart-native documentation generator. Beautiful docs, zero config.",
            "homepage": "https://github.com/nexlabstudio/stardust",
            "license": "Apache-2.0",
            "architecture": {
              "64bit": {
                "url": "https://github.com/nexlabstudio/stardust/releases/download/v${VERSION}/stardust-windows-x64.zip",
                "hash": "${HASH}"
              }
            },
            "bin": "stardust.exe",
            "checkver": {
              "github": "https://github.com/nexlabstudio/stardust"
            },
            "autoupdate": {
              "architecture": {
                "64bit": {
                  "url": "https://github.com/nexlabstudio/stardust/releases/download/v\$version/stardust-windows-x64.zip"
                }
              }
            }
          }
          EOF

      - name: Update Chocolatey package
        run: |
          VERSION=${{ steps.extract.outputs.version }}
          HASH=${{ steps.extract.outputs.windows_x64 }}

          # Update nuspec version
          sed -i "s/<version>.*<\/version>/<version>${VERSION}<\/version>/" chocolatey/stardust.nuspec

          # Update install script
          cat > chocolatey/tools/chocolateyinstall.ps1 << EOF
          \$ErrorActionPreference = 'Stop'

          \$packageName = 'stardust'
          \$toolsDir = "\$(Split-Path -Parent \$MyInvocation.MyCommand.Definition)"
          \$version = '${VERSION}'
          \$url64 = "https://github.com/nexlabstudio/stardust/releases/download/v\$version/stardust-windows-x64.zip"
          \$checksum64 = '${HASH}'

          \$packageArgs = @{
            packageName    = \$packageName
            unzipLocation  = \$toolsDir
            url64bit       = \$url64
            checksum64     = \$checksum64
            checksumType64 = 'sha256'
          }

          Install-ChocolateyZipPackage @packageArgs
          EOF

      - name: Update Snap version
        run: |
          VERSION=${{ steps.extract.outputs.version }}
          sed -i "s/^version: .*/version: '${VERSION}'/" snap/snapcraft.yaml

      - name: Commit and push changes
        run: |
          VERSION=${{ steps.extract.outputs.version }}
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/ scoop/ chocolatey/ snap/
          git commit -m "chore: update package manifests for v${VERSION}" || echo "No changes to commit"
          git push

      - name: Update Homebrew tap
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION=${{ steps.extract.outputs.version }}

          # Clone the homebrew-tap repo
          git clone https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/nexlabstudio/homebrew-tap.git homebrew-tap

          # Copy the formula
          mkdir -p homebrew-tap/Formula
          cp Formula/stardust.rb homebrew-tap/Formula/stardust.rb

          # Commit and push
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/stardust.rb
          git commit -m "stardust ${VERSION}" || echo "No changes to commit"

          # Pull with rebase to handle any new commits, then push
          git pull --rebase origin dev || true
          git push

          # Create a release in homebrew-tap repo
          gh release create "stardust-${VERSION}" \
            --repo nexlabstudio/homebrew-tap \
            --title "stardust ${VERSION}" \
            --notes "Update stardust formula to ${VERSION}. See full release notes: https://github.com/nexlabstudio/stardust/releases/tag/v${VERSION}" \
            || echo "Release already exists or failed to create"

  deploy-docs:
    name: Deploy Documentation
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Trigger docs deployment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh workflow run docs.yml --repo nexlabstudio/stardust --ref dev
